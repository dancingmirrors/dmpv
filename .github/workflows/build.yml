name: dmpv

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: actions/checkout@v4
        uses: actions/checkout@v4

      - name: dependencies
        run: |
          sudo sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources
          sudo apt-get update
          sudo apt-get install -y build-essential clang git meson nasm ninja-build yasm
          sudo apt-get build-dep -y mpv
          sudo apt-get install libavutil-dev libavcodec-dev libavformat-dev libavdevice-dev \
                       libavfilter-dev libswscale-dev libswresample-dev libpostproc-dev \
                       libplacebo-dev
          git clone --depth 1 https://github.com/ffmpeg/ffmpeg.git
          cd ffmpeg
          ./configure --enable-shared --prefix=/usr/local
          make -j4
          sudo make install

          git clone --depth 1 --recursive https://github.com/haasn/libplacebo.git
          cd libplacebo
          meson setup --backend=ninja --prefix=/usr/local build
          meson compile -C build
          sudo ninja -C build install

      - name: configure, build, install, test (GCC and clang)
        run: |
          ./configure
          make -j4
          sudo make install
          LD_LIBRARY_PATH=/usr/local/lib/x86_64-linux-gnu:/usr/local/lib:LD_LIBRARY_PATH ldd /usr/local/bin/dmpv
          LD_LIBRARY_PATH=/usr/local/lib/x86_64-linux-gnu:/usr/local/lib:LD_LIBRARY_PATH /usr/local/bin/dmpv

          make dist-clean
          CC=clang ./configure
          make -j4
          sudo make install
          LD_LIBRARY_PATH=/usr/local/lib/x86_64-linux-gnu:/usr/local/lib:LD_LIBRARY_PATH ldd /usr/local/bin/dmpv
          LD_LIBRARY_PATH=/usr/local/lib/x86_64-linux-gnu:/usr/local/lib:LD_LIBRARY_PATH /usr/local/bin/dmpv

          sudo rm -rf /usr/local/*
          make dist-clean
          ./configure
          make -j4
          sudo make install
          ldd /usr/local/bin/dmpv
          /usr/local/bin/dmpv
          make dist-clean
          CC=clang ./configure
          make -j4
          sudo make install
          ldd /usr/local/bin/dmpv
          /usr/local/bin/dmpv

          make dist-clean
          ./configure --enable-lgpl
          make -j4
          sudo make install
          ldd /usr/local/bin/dmpv
          /usr/local/bin/dmpv
          sudo make uninstall
